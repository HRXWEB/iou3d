cmake_minimum_required(VERSION 3.10)

# é¡¹ç›®åç§°å’Œç‰ˆæœ¬
project(iou3d VERSION 1.0.0 LANGUAGES CXX)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra")
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")
set(CMAKE_CXX_FLAGS_RELEASE "-O2 -DNDEBUG")

# é»˜è®¤æ„å»ºç±»å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

# é¡¹ç›®æºæ–‡ä»¶
set(SOURCES
    iou3d.cpp
)

set(HEADERS
    iou3d.h
)

# åˆ›å»ºé™æ€åº“
add_library(iou3d STATIC ${SOURCES} ${HEADERS})

# è®¾ç½®åŒ…å«ç›®å½•
target_include_directories(iou3d PUBLIC
    $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}>
    $<INSTALL_INTERFACE:include>
)

# ä¸ºåº“è®¾ç½®å±æ€§
set_target_properties(iou3d PROPERTIES
    VERSION ${PROJECT_VERSION}
    SOVERSION 1
    PUBLIC_HEADER "iou3d.h"
)

# å¦‚æœéœ€è¦æ•°å­¦åº“ï¼ˆæŸäº›ç³»ç»Ÿéœ€è¦ï¼‰
find_library(MATH_LIBRARY m)
if(MATH_LIBRARY)
    target_link_libraries(iou3d ${MATH_LIBRARY})
endif()

# é€‰é¡¹ï¼šæ˜¯å¦æ„å»ºæµ‹è¯•
option(BUILD_TESTS "Build test executable" ON)

if(BUILD_TESTS)
    # åˆ›å»ºä¸»æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
    add_executable(test_iou3d test_iou3d.cpp)
    
    # é“¾æ¥åˆ°iou3dåº“
    target_link_libraries(test_iou3d iou3d)
    
    # å¦‚æœæ‰¾åˆ°æ•°å­¦åº“ï¼Œä¹Ÿé“¾æ¥åˆ°æµ‹è¯•
    if(MATH_LIBRARY)
        target_link_libraries(test_iou3d ${MATH_LIBRARY})
    endif()
    
    # åˆ›å»ºæ—‹è½¬æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
    add_executable(rotation_test rotation_test.cpp)
    target_link_libraries(rotation_test iou3d)
    if(MATH_LIBRARY)
        target_link_libraries(rotation_test ${MATH_LIBRARY})
    endif()
    
    # æ·»åŠ æµ‹è¯•ç›®æ ‡
    enable_testing()
    add_test(NAME iou3d_test COMMAND test_iou3d)
    add_test(NAME rotation_test COMMAND rotation_test)
    
    # è®¾ç½®æµ‹è¯•å±æ€§
    set_tests_properties(iou3d_test PROPERTIES
        PASS_REGULAR_EXPRESSION "ğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼"
    )
    set_tests_properties(rotation_test PROPERTIES
        PASS_REGULAR_EXPRESSION "âœ“ æ—‹è½¬æ–¹å‘æ­£ç¡®ï¼"
    )
endif()

# é€‰é¡¹ï¼šæ˜¯å¦æ„å»ºç¤ºä¾‹
option(BUILD_EXAMPLES "Build example programs" OFF)

if(BUILD_EXAMPLES)
    add_subdirectory(examples)
endif()

# å®‰è£…é…ç½®
include(GNUInstallDirs)

# å®‰è£…åº“æ–‡ä»¶
install(TARGETS iou3d
    EXPORT iou3dTargets
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    PUBLIC_HEADER DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

# å®‰è£…å¯¼å‡ºæ–‡ä»¶
install(EXPORT iou3dTargets
    FILE iou3dTargets.cmake
    NAMESPACE iou3d::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/iou3d
)

# åˆ›å»ºé…ç½®æ–‡ä»¶
include(CMakePackageConfigHelpers)

configure_package_config_file(
    "${CMAKE_CURRENT_SOURCE_DIR}/cmake/iou3dConfig.cmake.in"
    "${CMAKE_CURRENT_BINARY_DIR}/iou3dConfig.cmake"
    INSTALL_DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/iou3d
)

write_basic_package_version_file(
    "${CMAKE_CURRENT_BINARY_DIR}/iou3dConfigVersion.cmake"
    VERSION ${PROJECT_VERSION}
    COMPATIBILITY SameMajorVersion
)

# å®‰è£…é…ç½®æ–‡ä»¶
install(FILES
    "${CMAKE_CURRENT_BINARY_DIR}/iou3dConfig.cmake"
    "${CMAKE_CURRENT_BINARY_DIR}/iou3dConfigVersion.cmake"
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/iou3d
)

# æ‰“å°é…ç½®ä¿¡æ¯
message(STATUS "")
message(STATUS "=================== IoU3D Configuration ===================")
message(STATUS "Version: ${PROJECT_VERSION}")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "C++ standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build tests: ${BUILD_TESTS}")
message(STATUS "Build examples: ${BUILD_EXAMPLES}")
message(STATUS "Install prefix: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "==========================================================")
message(STATUS "")
